#!/bin/bash

##############################################################################

# This setup script must be run before running Broo the first time.
# Copyright (C) 2021  Siddh Raman Pant

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# The online repository can be found at <https://github.com/siddhpant/broo>.

##############################################################################


# Exit on errors.
set -euo pipefail

set_up_mumble() {

    # Create the data directory for the database.
    if [[ ! -e $XDG_DATA_HOME/broo ]]; then
        mkdir -p $XDG_DATA_HOME/broo
    fi
    # Sets up Mumble for quick use later.

    # Purge any existing cache.
    if [[ -e $XDG_CACHE_HOME/broo ]]; then
        rm -rf $XDG_CACHE_HOME/broo
    fi

    # Create config folder or purge any existing one.
    if [[ -e $XDG_CONFIG_HOME/broo ]]; then
        rm -rf $XDG_CONFIG_HOME/broo/*
    else
        mkdir -p $XDG_CONFIG_HOME/broo
    fi

    # Set password for new / unregistered connections.
    pass=
    echo
    read -n1 -p "Do you want to set password for new connections? (y/n): " yn
    echo
    case $yn in
        y|Y) read -p "Enter password (NB: saved unencrypted): " pass; echo ;;
        n|N) ;;
        *) echo "Huh?? Defaulting to no password." ;;
    esac

    # Ask if logging is needed.
    logfile=
    read -n1 -p "Do you want to enable Mumble server logging? (y/n): " yn
    echo
    case $yn in
        y|Y) echo "Log will be stored in $XDG_CACHE_HOME/broo/murmur.log"
             mkdir $XDG_CACHE_HOME/broo
             logfile=$XDG_CACHE_HOME/broo/murmur.log
             ;;
        n|N) ;;
        *) echo "Huh?? Defaulting to no logging." ;;
    esac

    # Create the murmur.ini file.
    echo "Assuming your UID won't change in future."
    echo -e "; Generated by Broo

        bonjour=true
        bandwidth=558000 ; Max possible BW, see Mumble source on GitHub.
        registerName=Broo
        database=$XDG_DATA_HOME/broo/murmur.sqlite
        logfile=$logfile
        logdays=-1  ; Don't store logs in the database.
        password=$pass
        welcometext=
    " | awk '{$1=$1};1' > $XDG_CONFIG_HOME/broo/murmur.ini

    # Tell user to use the Mumble GUI for configuring it once.
    echo -e "
        Once Mumble starts, do the following, for low latency:

        - Connect to the server on 127.0.0.1.
        - Right click on your user and make sure it is muted.
        - Right click on your user and click on 'Register' to register it.
        - Go to Configure -> Audio Wizard and go through the steps.
        - Go to Configure -> Certificate Wizard and go through the steps.
        - Then open settings (Configure -> Settings).
        - In the 'Audio Input' screen, disable all types of audio processing.
        - If you want, you can proceed to change other settings at your will.
        - After you are done, close Mumble and come back here.

        This is a one time setup process, so don't skip it!
    " | awk '{$1=$1};1'

    read -n1 -p "Press any key to start Mumble..."

    # Start the server.
    if [[ ! -z $(which mumble-server) ]]; then
        nohup pw-jack mumble-server -ini $XDG_CONFIG_HOME/broo/murmur.ini &>/dev/null 2>&1 &
    else
        nohup pw-jack murmurd -ini $XDG_CONFIG_HOME/broo/murmur.ini &>/dev/null 2>&1 &
    fi

    murmur_pid=$!
    sleep 3  # Give time for it to set up.

    # Start the GUI.
    mumble >/dev/null 2>&1

    # Stop the server.
    kill $murmur_pid

    echo "Done setting up Mumble!"
}  # End of set_up_mumble()

# Script will start executing from here when run from terminal.

echo -e "Setting up Broo...\n"

set_up_mumble

echo -e "
    Now set up the mobile app.
    - For Android: get the Mumla app from F-Droid.
    - For iOS: get the Official Mumble app from App Store.

    After installing the app, open its settings and do the following:
    - Set the 'Input Sample Rate' to its highest value.
    - Set 'Input Quality' to its highest value.
    - Set 'Audio per packet' to 10ms or 20ms (whichever results in higher
    quality when transmitting voice; use 10ms if both have same quality).
" | awk '{$1=$1};1'

echo -e "We are done! Start Broo with the 'broo' command anytime!"


# End of file.
